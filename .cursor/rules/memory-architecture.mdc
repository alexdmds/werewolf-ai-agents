---
alwaysApply: true
---
# ğŸ§  Architecture de la mÃ©moire et du contexte passÃ© aux agents

Ce document dÃ©crit la maniÃ¨re dont est construite la **mÃ©moire contextuelle** transmise Ã  chaque agent (joueur IA) Ã  chaque appel LLM, que ce soit pour parler (`talk()`), voter (`vote()`), ou agir la nuit.

L'objectif est d'assurer :
- la **cohÃ©rence** des dÃ©cisions d'un agent avec son historique personnel,
- la **comprÃ©hension de l'Ã©tat du jeu** (joueurs en vie, morts, accusationsâ€¦),
- un **prompt compact, lisible et contrÃ´lÃ©**, Ã©vitant de surcharger la fenÃªtre de contexte.

---

## ğŸ§© Structure du prompt complet envoyÃ© Ã  un agent

Le prompt construit Ã  chaque appel est composÃ© de 6 blocs, injectÃ©s dynamiquement :

1. **System Prompt** (prompt systÃ¨me / rÃ´le)
2. **Rappel des rÃ¨gles** (optionnel)
3. **Ã‰tat actuel du jeu**
4. **MÃ©moire personnelle de l'agent**
5. **Historique public rÃ©cent**
6. **Instruction/action Ã  exÃ©cuter**

### Exemple dâ€™assemblage :

Tu es un agent IA jouant au jeu du Loup-Garou. Ton rÃ´le est : Loup-Garou.
Tu fais semblant dâ€™Ãªtre un villageois. Tu veux Ã©liminer les autres sans Ãªtre dÃ©couvert.

Tour actuel : 3
Joueurs encore en vie : A, B, C, D
Morts prÃ©cÃ©dents :
	â€¢	F (vote, villageois)
	â€¢	E (nuit, inconnu)

MÃ©moire :
	â€¢	T1 : Agent C mâ€™a accusÃ©
	â€¢	T2 : Jâ€™ai votÃ© contre Agent F
	â€¢	T2 : Agent B a affirmÃ© Ãªtre voyante

Discussion prÃ©cÃ©dente :
	â€¢	Agent A : â€œJe pense que C est suspectâ€
	â€¢	Agent C : â€œB semble trop calmeâ€
	â€¢	Agent D : â€œJe vais voter contre Bâ€

Tu dois maintenant voter. RÃ©ponds uniquement par : NOM â€“ RAISON

---

## ğŸ—ï¸ DÃ©tail des blocs

### 1. System Prompt
DÃ©fini dans `prompts/system_templates.py`. Il contient :
- le rÃ´le du joueur
- son comportement attendu (ex : bluff, honnÃªtetÃ©)
- des informations spÃ©ciales (ex : liste des autres loups)

InjectÃ© dans la partie `system` du prompt pour les API style OpenAI.

---

### 2. Rappel des rÃ¨gles (optionnel)
AjoutÃ© si `turn <= 2` ou en mode debug :
- rappels de la mÃ©canique (discussion > vote > nuit)
- but du rÃ´le

Permet dâ€™Ã©viter les dÃ©viations de comportement au dÃ©marrage.

---

### 3. Ã‰tat actuel du jeu
Construit dynamiquement depuis `game_state` :
- numÃ©ro du tour
- liste des joueurs vivants
- liste des morts et cause (vote ou nuit), rÃ´le connu si applicable

MÃ©thodes suggÃ©rÃ©es :
```python
game_state.get_alive_names()
game_state.get_deaths_summary()


â¸»

4. MÃ©moire personnelle de lâ€™agent

StockÃ©e dans AgentMemory (une instance par agent) :
	â€¢	ajoutÃ©e via .add(message)
	â€¢	lue via .get_recent(n) ou .get_summary()
	â€¢	contient ce que lâ€™agent a perÃ§u (accusations, votes, visionsâ€¦)

Nâ€™est pas partagÃ©e entre agents (subjective).

â¸»

5. Historique public

Extraits rÃ©cents des discussions visibles par tous :
	â€¢	rÃ©cupÃ©rÃ©s depuis game_state.log
	â€¢	forme : Agent X : "..."
	â€¢	on injecte typiquement les 3â€“5 derniers Ã©changes

MÃ©thode suggÃ©rÃ©e :

game_state.get_last_discussion(n)


â¸»

6. Instruction/action demandÃ©e

Varie selon la phase :
	â€¢	talk : â€œExprime ton avis sur les autres joueurs.â€
	â€¢	vote : â€œVote pour un joueur en rÃ©pondant uniquement : NOM â€“ RAISONâ€

Elle est toujours explicite, directive, et concise pour guider le LLM.

â¸»

ğŸ§  Fonction de gÃ©nÃ©ration du prompt

Chaque agent appelle une mÃ©thode build_prompt(action: str, game_state: GameState) qui retourne un prompt Ã  envoyer au LLM.

Responsable de :
	â€¢	combiner tous les blocs ci-dessus
	â€¢	formater le prompt lisiblement
	â€¢	adapter Ã  lâ€™action courante

â¸»

ğŸ” Exemple dans le code (dans un agent)

def vote(self, game_state: GameState) -> str:
    prompt = self.build_prompt(action="vote", game_state=game_state)
    raw_response = call_llm(prompt, system_prompt=self.system_prompt)
    return parse_vote_response(raw_response, valid_names=game_state.get_alive_names())


â¸»

ğŸ” RÃ¨gle de sÃ©curitÃ©

Les agents ne conservent aucune mÃ©moire native entre les appels :
	â€¢	toute â€œmÃ©moireâ€ est stockÃ©e manuellement dans leur AgentMemory
	â€¢	Ã  chaque appel, on injecte les rÃ©sumÃ©s ou Ã©vÃ©nements rÃ©cents nÃ©cessaires

â¸»

âœ… RÃ©sumÃ©

Ã‰lÃ©ment	GÃ©rÃ© par
Prompt systÃ¨me	system_templates.py
MÃ©moire subjective de lâ€™agent	AgentMemory
Ã‰tat global	GameState
Historique de discussion	GameState.log_discussion()
Assemblage final	build_prompt()
Envoi LLM + parsing	llm_interface.py